---
title: "Projet S9"
author: "Adrien Faissat, Guillaume Schmit, Omar Himych, Morgane Roy"
date: "03/03/2022"
output:
  html_document:
    toc: yes
    toc_depth: 4
    number_sections: yes
---

```{r setup, include=FALSE}
library(readr)
library(ggplot2)
library(lubridate)
library(dplyr)
library(ReIns)
library(extRemes)

# Setup of options for the rmarkdown document
knitr::opts_chunk$set(echo = TRUE, # By default, codes are shown
                      warning = FALSE, # Warnings are not printed
                      message = FALSE, # Messages are not printed
                      out.width = "90%",
                      fig.align = 'center') # Codes results are cached into a 
# dedicated _cache directory which should be ignored by git (and emptied regularly)

## https://bookdown.org/yihui/rmarkdown/markdown-syntax.html pour des tips

```

# Introdution

## Intérêt général des indices
## Types d'indices

# Indices étudiés  {.tabset}

## Fosberg Fire Weather Index (FFWI)

## FWI Canadien

## Angstrom Index

## MacArthur Grassland Mark 5 Index

# Discussion comparative des formules

## Variables d'entrée

## Statique vs Dynamique

## Échelles temporelles

# Implémentation des calculs {.tabset}

Nous commençons par exploiter les données recueillies par la station de Salon-de-Provence.
Nous avons également utilisé la base de données en ligne Prométhée afin de recueillir la totalité des incendies ayant eu lieu sur la période étudiée dans le département. Cela nous permettra de confronter les indices avec la réalité.   

```{r data_loading, warning=FALSE, message=FALSE, cache=TRUE}
  RR_81_99 <- read_delim("data/Construction_FWI_horaire_METEO_STATION_RR_81-99.csv",delim = ";", escape_double = FALSE, trim_ws = TRUE)
  RR_2000_2021 <- read_delim("data/Construction_FWI_horaire_METEO_STATION_RR_2000-2021.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)
  T_81_99 <- read_delim("data/Construction_FWI_horaire_METEO_STATION_T_81-99.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)
  T_2000_2021 <- read_delim("data/Construction_FWI_horaire_METEO_STATION_T_2000-2021.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)
  U_81_99 <- read_delim("data/Construction_FWI_horaire_METEO_STATION_U_81-99.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)
  U_2000_2021 <- read_delim("data/Construction_FWI_horaire_METEO_STATION_U_2000-2021.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)
  VT_81_99 <- read_delim("data/Construction_FWI_horaire_METEO_STATION_VT_81-99.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)
  VT_2000_2021 <- read_delim("data/Construction_FWI_horaire_METEO_STATION_VT_2000-2021.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)
  Incendie_81_2021 <- read_delim("data/liste_incendies_91_2021.csv", delim=";", escape_double = FALSE, trim_ws = TRUE)
```

## Fosberg Fire Weather Index (FFWI)

## FWI Canadien

## Angstrom Index

```{r angstrom_implementation, cache=TRUE}
T_13h <- rbind(T_81_99[T_81_99$HEURE == 13,],T_2000_2021[T_2000_2021$HEURE == 13,])
U_13h <- rbind(U_81_99[U_81_99$HEURE == 13,],U_2000_2021[U_2000_2021$HEURE == 13,])
  
Angstrom_Index <- data.frame(matrix(ncol=7,nrow=nrow(T_13h)))
colnames(Angstrom_Index) <- c("DATE", "AN", "MOIS", "JOUR","ANGSTROM_INDEX", "U", "T")

for(i in 1:nrow(Angstrom_Index))
{
  ligne_humidite <- U_13h[i,]
  ligne_temperature <- T_13h[T_13h$AN == ligne_humidite$AN & T_13h$MOIS == ligne_humidite$MOIS & T_13h$JOUR == ligne_humidite$JOUR,]
  
  index <- (ligne_humidite$U / 20) + (27 - ligne_temperature$T)/10
  
  Angstrom_Index[i,] <- c(as.Date(gsub(" ", "", paste(ligne_humidite$JOUR,"/",ligne_humidite$MOIS,"/",ligne_humidite$AN)),format="%d/%m/%Y", origin="1970-01-01"),ligne_humidite$AN, ligne_humidite$MOIS, ligne_humidite$JOUR, index, ligne_humidite$U, ligne_temperature$T)

}


nb_iteration = nrow(Angstrom_Index)
Index_Summer <- data.frame(DATE=numeric(), AN=numeric(), MOIS=numeric(), JOUR=numeric(),ANGSTROM_INDEX=numeric(), U = numeric(), T=numeric(), stringsAsFactors=FALSE)

for (i in 1:nb_iteration){
  month <- month(as.Date(Angstrom_Index[i,]$DATE, origin="1970-01-01"))
  if(month == 6 || month == 7 || month == 8){
      Index_Summer[nrow(Index_Summer)+1,] <- Angstrom_Index[i,]
  }
}
  
```

## MacArthur Grassland Mark 5 Index

# Analyse des séries d'indice {.tabset}

Nous mettons ici une fonction qui nous aidera pour les corrélations extrêmales entre séries :

````{r}
extremal_correlation_input_output <- function(input,output, quant){
  u1 = quantile(output, quant, na.rm = TRUE)
  u2 = quantile(input, quant, na.rm = TRUE)
  xi.est.quantile = sum(output > u1 & input > u2)/sum(output > u1)
  
  xi.est.quantile
}

````
## Fosberg Fire Weather Index (FFWI)
### Tail index 
### Auto-corrélation extrêmale
### Corrélation extrêmale entre les séries

## FWI Canadien

### Tail index 
### Auto-corrélation extrêmale
### Corrélation extrêmale entre les séries

## Angstrom Index

### Analyse générale

```` {r angstrom_general_analysis, warning=FALSE}

acf(Angstrom_Index$ANGSTROM_INDEX, na.action = na.pass, lag.max = 21, main="Auto-corrélation temporelle de l'indice")

acf(Index_Summer$ANGSTROM_INDEX, na.action = na.pass, lag.max = 21, main ="Auto-corrélation temporelle de l'indice pris sur les périodes estivales")

````

On constate que l'auto-corrélation est plus élevée quand on considère les périodes non-estivales, ce qui n'est pas particulièrement étonnant : il paraît cohérent que les périodes moins chaudes et moins sèches soient moins propices à des valeurs extrêmes de risque d'incendie, et donc une certaine corrélation entre les jours "non-incendie".

````{r}
seuil_incendie <- 10000 #m2 seuil pour les incendies

date_debut <- as.Date("01/06/2000","%d/%m/%Y")
date_fin <- as.Date("22/12/2020","%d/%m/%Y")

########

Incendies_filtered <- Incendie_81_2021[Incendie_81_2021$`Surface parcourue (m2)` >= seuil_incendie,]


graph_angstrom_index <- Angstrom_Index %>% filter(between(as.Date(DATE,origin="1970-01-01"), date_debut,date_fin))

graph_summer_angstrom_index <- Index_Summer %>% filter(between(as.Date(DATE,origin="1970-01-01"), date_debut,date_fin))


### Plotting all dates within chosen range ###

ggplot(data = graph_angstrom_index,
       mapping = aes(x = as.Date(DATE, origin="1970-01-01"), y = ANGSTROM_INDEX, color = ANGSTROM_INDEX, xmin = date_debut,xmax=date_fin)) +
  geom_point() +
  scale_color_gradient(guide="none", low="red", high="green") +
  labs(x = "Date", y = "Angstrom Index") +
  geom_point(data = graph_angstrom_index %>% filter(as.Date(DATE, origin="1970-01-01") %in% as.Date.character(Incendies_filtered$Alerte,format="%d/%m/%Y %H:%M", origin="1970-01-01")),
             pch=16, size=2, colour="black")

### Plotting all summer dates within chosen range ###

ggplot(data = graph_summer_angstrom_index,
       mapping = aes(x = as.Date(DATE, origin="1970-01-01"), y = ANGSTROM_INDEX, color = ANGSTROM_INDEX, xmin = date_debut,xmax=date_fin)) +
  geom_point() +
  scale_color_gradient(guide="none", low="red", high="green") +
  labs(x = "Date", y = "Angstrom Index") +
  geom_point(data = graph_summer_angstrom_index %>% filter(as.Date(DATE, origin="1970-01-01") %in% as.Date.character(Incendies_filtered$Alerte,format="%d/%m/%Y %H:%M", origin="1970-01-01")),
             pch=16, size=2, colour="black")


````

On constate que la majorité des gros incendies (> 10000 m²) ont bien lieu lors des périodes où le risque prévu par l'indice Angstrom est est élevé (donc valeur de l'indice faible).

### Tail index 

```` {r}

moment_data <- na.omit(Angstrom_Index)
moment_data$ANGSTROM_INDEX <- moment_data$ANGSTROM_INDEX *-1
min_moment <- min(moment_data$ANGSTROM_INDEX)
moment_data$ANGSTROM_INDEX <- moment_data$ANGSTROM_INDEX - min_moment +1
moment_data <- moment_data[moment_data$ANGSTROM_INDEX > 0,]
M <- Moment(moment_data$ANGSTROM_INDEX, logk = FALSE, plot = TRUE, main = "Moment estimate of the Angstrom Index")

plot(M$k[M$k %in% 25:500], M$gamma[M$k %in% 25:500], main="", xlab="Number of extreme events", ylab="Tail index")

````

### Auto-corrélation extrêmale

````{r}


###

moment_summer <- na.omit(Index_Summer)
prob = .95 # probability for quantile to be used as threshold
tmp = atdf(as.ts(moment_summer$ANGSTROM_INDEX), u = prob, plot = FALSE, lag.max = 21, type = "rho")
par(mar = c(5, 5, .5, .5), cex.lab = 2, cex.axis = 2, lwd = 2, cex = 1)
plot(tmp, main = "", xlab = "h", ylab = expression(chi(u,h)))
lines(c(0, 100), rep(1-prob,2), lwd = 2, lty = 2, col = "red")

````

### Corrélation extrêmale entre les séries

## MacArthur Grassland Mark 5 Index
### Tail index 
### Auto-corrélation extrêmale
### Corrélation extrêmale entre les séries




# Analyse par rapport aux données d'entrée {.tabset}

## Fosberg Fire Weather Index (FFWI)

## FWI Canadien

## Angstrom Index

Nous allons commencer par analyser la sensibilité de cet indice par rapport à la température.
Afin d'avoir des extrêmes qui correspondent, nous inversons les valeurs de l'indice (étant donné que de base, une valeur faible indique un potentiel plus élevé d'incendie).

```` {r angstrom_input_temperature, warning=FALSE}
### plotting temperatures within chosen range ###

ggplot(data = graph_angstrom_index,
       mapping = aes(x = as.Date(DATE, origin="1970-01-01"), y = T, color = T, xmin = date_debut,xmax=date_fin)) +
  geom_point() +
  scale_color_gradient(guide="none", low="green", high="red") +
  labs(x = "Date", y = "Temperatures") +
  geom_point(data = graph_angstrom_index %>% filter(as.Date(DATE, origin="1970-01-01") %in% as.Date.character(Incendies_filtered$Alerte,format="%d/%m/%Y %H:%M", origin="1970-01-01")),
             pch=16, size=2, colour="black")

quant = 0.95

Angstrom_Index_omit <- na.omit(Angstrom_Index)

Angstrom_Index_omit_reverse <- Angstrom_Index_omit
Angstrom_Index_omit_reverse$ANGSTROM_INDEX <- Angstrom_Index_omit_reverse$ANGSTROM_INDEX *-1
min_Angstrom_Index_omit_reverse <- min(Angstrom_Index_omit_reverse$ANGSTROM_INDEX)
Angstrom_Index_omit_reverse$ANGSTROM_INDEX <- Angstrom_Index_omit_reverse$ANGSTROM_INDEX - min_Angstrom_Index_omit_reverse +1

extremal_correlation_input_output(Angstrom_Index_omit_reverse$T, Angstrom_Index_omit_reverse$ANGSTROM_INDEX,quant)

````
Pour étudier la sensibilité vis-à-vis de l'humidité, nous n'utilisons pas les valeurs inversées de l'indice car nous voulons vérifier une corrélation inversée : lorsque l'humidité est très élevée, il est cohérent d'attendre un indice indiquant un risque moins élevé d'incendies, et donc une valeur élevée.

````{r angstrom_input_humidity, warning=FALSE}
### plotting humidty within chosen range ###

ggplot(data = graph_angstrom_index,
       mapping = aes(x = as.Date(DATE, origin="1970-01-01"), y = U, color = U, xmin = date_debut,xmax=date_fin)) +
  geom_point() +
  scale_color_gradient(guide="none", low="red", high="green") +
  labs(x = "Date", y = "Temperatures") +
  geom_point(data = graph_angstrom_index %>% filter(as.Date(DATE, origin="1970-01-01") %in% as.Date.character(Incendies_filtered$Alerte,format="%d/%m/%Y %H:%M", origin="1970-01-01")),
             pch=16, size=2, colour="black")

extremal_correlation_input_output(Angstrom_Index_omit$U,Angstrom_Index_omit$ANGSTROM_INDEX,quant)

````
Nous trouvons une corrélation inversée plus élevée que la corrélation avec la température, ce qui permet de conclure que l'indice Angstrom est légèrement plus sensible à la sécheresse qu'à la température.

## MacArthur Grassland Mark 5 Index
# Conclusion